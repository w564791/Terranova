---
name: terraform_module_best_practices
layer: domain
description: Terraform Module 配置最佳实践，提供安全、高可用、成本优化等方面的配置建议
tags: ["terraform", "terraform-docs", "module", "best-practices", "iac", "aws"]
---

## Terraform Module 最佳实践

### 命名规范

#### 资源命名
- 使用**小写字母**和**连字符**（kebab-case）
- 包含环境标识（prod、staging、dev）
- 包含用途说明
- 示例：`web-server-prod`、`api-gateway-staging`

#### 变量命名
- 使用**小写字母**和**下划线**（snake_case）
- 名称应自解释
- 示例：`instance_type`、`security_group_ids`

#### 标签键命名
- 使用**小写字母**和**连字符**
- 遵循云服务商的标签规范
- 示例：`business-line`、`managed-by`

### 安全配置

#### 加密配置
| 场景 | 推荐配置 | 说明 |
|------|----------|------|
| EBS 卷 | 启用加密 | 使用 KMS 密钥加密 |
| S3 存储桶 | 启用服务端加密 | SSE-S3 或 SSE-KMS |
| RDS 数据库 | 启用存储加密 | 使用 KMS 密钥 |
| 传输数据 | 使用 TLS 1.2+ | 禁用旧版本 SSL/TLS |

#### 保护机制
| 配置项 | 推荐值 | 说明 |
|--------|--------|------|
| `disable_api_termination` | `true` | 防止误删除实例 |
| `disable_api_stop` | `true`（生产环境） | 防止误停止实例 |
| `deletion_protection` | `true` | 防止误删除资源 |
| `prevent_destroy` | `true`（关键资源） | Terraform 层面保护 |

#### 最小权限原则
- 安全组只开放**必要端口**
- IAM 角色只授予**必要权限**
- 使用**私有子网**部署内部服务
- 敏感数据使用 **Secrets Manager** 或 **Parameter Store**

### 高可用配置

#### 多可用区部署
| 资源类型 | 推荐配置 |
|----------|----------|
| EC2 实例 | 跨 2-3 个可用区部署 |
| RDS 数据库 | 启用 Multi-AZ |
| EKS 节点组 | 配置多可用区 |
| ALB/NLB | 跨可用区分布 |

#### 自动扩缩容
| 配置项 | 推荐值 | 说明 |
|--------|--------|------|
| `min_size` | >= 2 | 保证最小可用实例数 |
| `max_size` | 根据负载设置 | 预留扩展空间 |
| `desired_size` | >= `min_size` | 期望运行实例数 |

#### 健康检查
- 配置**应用级健康检查**（不仅是 TCP 端口检查）
- 设置合理的**健康检查间隔**和**阈值**
- 配置**自动恢复**机制

### 成本优化

#### 实例类型选择
| 场景 | 推荐 | 说明 |
|------|------|------|
| 开发/测试 | t3/t3a 系列 | 可突增性能，成本低 |
| 稳定负载 | m5/m6i 系列 | 通用型，性价比高 |
| 计算密集 | c5/c6i 系列 | 计算优化型 |
| 内存密集 | r5/r6i 系列 | 内存优化型 |

#### Spot 实例使用
| 场景 | 是否推荐 | 说明 |
|------|----------|------|
| 批处理任务 | ✅ 推荐 | 可中断，成本节省 60-90% |
| 开发环境 | ✅ 推荐 | 可接受中断 |
| 生产环境核心服务 | ❌ 不推荐 | 需要稳定性 |
| 无状态服务 | ✅ 推荐 | 配合 On-Demand 混合使用 |

#### 资源清理
- 配置**自动关机策略**（非生产环境）
- 定期清理**未使用的资源**（EBS 快照、AMI、弹性 IP）
- 使用**生命周期策略**管理日志和备份

### 标签规范

#### 必须标签
| 标签键 | 说明 | 示例值 |
|--------|------|--------|
| `business-line` | 业务线 | `exchange`、`wallet` |
| `managed-by` | 管理方式 | `terraform`、`manual` |
| `environment` | 环境 | `prod`、`staging`、`dev` |

#### 推荐标签
| 标签键 | 说明 | 示例值 |
|--------|------|--------|
| `owner` | 负责人/团队 | `platform-team` |
| `project` | 项目名称 | `iac-platform` |
| `cost-center` | 成本中心 | `engineering` |
| `created-by` | 创建者 | `ci-pipeline` |

### 网络配置

#### 子网规划
| 子网类型 | 用途 | 路由 |
|----------|------|------|
| 公有子网 | ALB、NAT Gateway、Bastion | 有 IGW 路由 |
| 私有子网 | 应用服务器、数据库 | 通过 NAT 访问外网 |
| 隔离子网 | 敏感数据、内部服务 | 无外网访问 |

#### 安全组规则
- **入站规则**：只允许必要的源和端口
- **出站规则**：限制到必要的目标
- 使用**安全组引用**而非 IP 地址（便于维护）
- 添加**描述**说明每条规则的用途

### 监控和日志

#### 必须启用
| 配置项 | 说明 |
|--------|------|
| CloudWatch 指标 | 基础监控 |
| CloudWatch 日志 | 应用日志收集 |
| CloudTrail | API 调用审计 |
| VPC Flow Logs | 网络流量日志 |

#### 告警配置
- CPU 使用率 > 80% 持续 5 分钟
- 内存使用率 > 85%
- 磁盘使用率 > 90%
- 健康检查失败