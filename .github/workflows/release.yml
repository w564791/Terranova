name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  DOCKER_REPO: w564791
  GO_VERSION: "1.25"
  NODE_VERSION: "22"

jobs:
  # ===========================================================================
  # Job 1: 构建全平台 Go 二进制 (server + agent)
  # ===========================================================================
  build-binaries:
    name: Build binaries (${{ matrix.goos }}/${{ matrix.goarch }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: windows
            goarch: amd64
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: backend/go.sum

      - name: Build server
        env:
          CGO_ENABLED: "0"
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          cd backend
          EXT=""
          if [ "${{ matrix.goos }}" = "windows" ]; then EXT=".exe"; fi
          go build -ldflags="-s -w" -o ../dist/iac-platform-${{ matrix.goos }}-${{ matrix.goarch }}${EXT} main.go

      - name: Build agent
        env:
          CGO_ENABLED: "0"
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          cd backend
          EXT=""
          if [ "${{ matrix.goos }}" = "windows" ]; then EXT=".exe"; fi
          go build -ldflags="-s -w" -o ../dist/iac-agent-${{ matrix.goos }}-${{ matrix.goarch }}${EXT} cmd/agent/main.go

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/

  # ===========================================================================
  # Job 2: 构建前端静态文件
  # ===========================================================================
  build-frontend:
    name: Build frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: cd frontend && npm ci --no-audit

      - name: Build
        run: cd frontend && npx vite build

      - name: Archive frontend dist
        run: tar -czf dist/frontend-dist.tar.gz -C frontend/dist .
        working-directory: ${{ github.workspace }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: dist/frontend-dist.tar.gz

  # ===========================================================================
  # Job 3: 构建并推送多架构 Docker 镜像
  # ===========================================================================
  docker-images:
    name: Docker images
    runs-on: ubuntu-latest
    needs: []  # 与二进制构建并行，Docker 用自己的多阶段构建
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      # -- Backend (server) --
      - name: Build and push backend
        uses: docker/build-push-action@v6
        with:
          context: backend/
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.DOCKER_REPO }}/iac-platform:${{ steps.version.outputs.VERSION }}
            ${{ env.DOCKER_REPO }}/iac-platform:latest
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend

      # -- Frontend --
      - name: Build and push frontend
        uses: docker/build-push-action@v6
        with:
          context: frontend/
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.DOCKER_REPO }}/iac-frontend:${{ steps.version.outputs.VERSION }}
            ${{ env.DOCKER_REPO }}/iac-frontend:latest
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend

      # -- Agent --
      - name: Build and push agent
        uses: docker/build-push-action@v6
        with:
          context: backend/
          file: backend/cmd/agent/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.DOCKER_REPO }}/iac-agent:${{ steps.version.outputs.VERSION }}
            ${{ env.DOCKER_REPO }}/iac-agent:latest
          cache-from: type=gha,scope=agent
          cache-to: type=gha,mode=max,scope=agent

      # -- DB Init --
      - name: Build and push db-init
        uses: docker/build-push-action@v6
        with:
          context: manifests/db/
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.DOCKER_REPO }}/iac-db-init:${{ steps.version.outputs.VERSION }}
            ${{ env.DOCKER_REPO }}/iac-db-init:latest
          cache-from: type=gha,scope=db-init
          cache-to: type=gha,mode=max,scope=db-init

  # ===========================================================================
  # Job 4: 创建 GitHub Release
  # ===========================================================================
  release:
    name: Create release
    runs-on: ubuntu-latest
    needs: [build-binaries, build-frontend]
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Prepare release assets
        run: |
          mkdir -p release
          # 打包每个平台的二进制
          for dir in artifacts/binaries-*/; do
            for bin in "$dir"/*; do
              cp "$bin" release/
            done
          done
          # 前端静态文件
          cp artifacts/frontend-dist/frontend-dist.tar.gz release/
          # 生成 checksums
          cd release && sha256sum * > checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: release/*
