# 前端路由（所有用户流量走 nginx，nginx 反代 /api/ 到后端）
# nginx 已配置 WebSocket 支持（proxy_http_version 1.1 + Upgrade headers）
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: iac-frontend
  namespace: terraform
  labels:
    app.kubernetes.io/name: iac-platform
spec:
  parentRefs:
    - name: iac-platform
      sectionName: https
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      timeouts:
        request: 600s
        backendRequest: 600s
      backendRefs:
        - name: iac-frontend
          port: 443
---
# 后端健康检查（直连，不经过 nginx）
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: iac-platform-api
  namespace: terraform
  labels:
    app.kubernetes.io/name: iac-platform
spec:
  parentRefs:
    - name: iac-platform
      sectionName: https
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /health
      backendRefs:
        - name: iac-platform
          port: 8080
