apiVersion: constraints.gatekeeper.sh/v1beta1
kind: RestrictSecretAccess
metadata:
  name: restrict-secret-terraform-ns
spec:
  enforcementAction: deny
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
    namespaces:
      - terraform
  parameters:
    protectedSecrets:
      # 数据库凭证
      - secretName: iac-platform
        allowedPodLabels:
          - labels:
              app.kubernetes.io/name: iac-platform
              app.kubernetes.io/component: backend
          - labels:
              app.kubernetes.io/name: iac-platform
              app.kubernetes.io/component: postgres
          - labels:
              app.kubernetes.io/name: iac-platform
              app.kubernetes.io/component: db-init
          - labels:
              app: iac-platform
              component: agent
      # JWT 签名密钥
      - secretName: iac-jwt
        allowedPodLabels:
          - labels:
              app.kubernetes.io/name: iac-platform
              app.kubernetes.io/component: backend
          - labels:
              app: iac-platform
              component: agent
      # Backend TLS 证书
      - secretName: iac-platform-tls
        allowedPodLabels:
          - labels:
              app.kubernetes.io/name: iac-platform
              app.kubernetes.io/component: backend
      # Frontend TLS 证书
      - secretName: iac-frontend-tls
        allowedPodLabels:
          - labels:
              app.kubernetes.io/name: iac-platform
              app.kubernetes.io/component: frontend
      # PostgreSQL TLS 证书
      - secretName: iac-postgres-tls
        allowedPodLabels:
          - labels:
              app.kubernetes.io/name: iac-platform
              app.kubernetes.io/component: postgres
      # 内部 CA 证书
      - secretName: iac-internal-ca
        allowedPodLabels:
          - labels:
              app.kubernetes.io/name: iac-platform
              app.kubernetes.io/component: db-init
      # Gateway TLS 证书 — 无 Pod 应挂载（仅 Gateway 资源引用）
      - secretName: iac-gateway-tls
        allowedPodLabels: []
