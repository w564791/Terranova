# Workspace模块 - 总览与架构

> **文档版本**: v2.0  
> **最后更新**: 2025-10-09  
> **适用范围**: 多人/多AI协作开发  
> **状态**: 完整产品设计

## 📘 概述

Workspace模块是IaC平台的核心子系统，负责Terraform工作空间的**定义、执行、版本控制、状态管理、日志输出与智能通知**。平台以HCP Terraform为基础设计，融合多执行环境（Local/Agent/K8s）与AI能力，实现自动化、智能化基础设施管理。

## 🎯 核心目标

1. **提升灵活性**: 支持多种执行环境和策略
2. **增强可靠性**: 文件存储重试机制和版本控制
3. **改善安全性**: Workspace锁定和权限控制
4. **优化体验**: 任务队列管理和状态可视化
5. **智能化管理**: AI驱动的漂移检测和风险评估

## 🏗️ 架构设计

### 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        用户界面层                              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │Workspace │  │  Task    │  │  State   │  │  Drift   │   │
│  │Management│  │Management│  │ Version  │  │Detection │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                        API网关层                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  REST API  │  WebSocket  │  Webhook  │  GraphQL     │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                        业务逻辑层                             │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │Workspace │  │   Task   │  │  State   │  │  Notify  │  │
│  │ Service  │  │ Executor │  │ Manager  │  │  System  │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │   Lock   │  │   Log    │  │   Drift  │  │ Insert   │  │
│  │ Manager  │  │  System  │  │ Detector │  │  Tasks   │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                        执行层                                 │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                  │
│  │  Local   │  │  Agent   │  │   K8s    │                  │
│  │ Executor │  │ Executor │  │ Executor │                  │
│  └──────────┘  └──────────┘  └──────────┘                  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                        存储层                                 │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │PostgreSQL│  │    S3    │  │   Loki   │  │Prometheus│  │
│  │(Metadata)│  │ (State)  │  │  (Logs)  │  │(Metrics) │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 🧩 核心模块

### 1. Workspace管理
- Workspace CRUD操作
- 标签系统（Tags）
- 变量管理（Variables + System Variables）
- 锁定机制
- Provider配置

### 2. 任务执行
- Plan任务
- Apply任务
- 插入任务流（未来扩展）
- 任务队列管理
- 并发控制

### 3. 执行模式
- Local模式：本地执行
- Agent模式：分布式执行
- K8s模式：容器化执行

### 4. State管理
- State版本控制
- State锁机制
- 版本回滚
- 差异对比

### 5. 通知系统（第一版：基础Webhook）
- 事件驱动架构
- Webhook通知
- 事件模板化
- 未来扩展：Prometheus/Loki/S3

### 6. 日志系统（第一版：基础日志）
- 结构化日志
- 日志存储
- 未来扩展：Elasticsearch/Loki/S3

### 7. AI Drift检测（后续迭代）
- 周期性检测
- AI分析
- 智能报告
- 自动修复建议

### 8. Plan可视化
- 差异树状展示
- 资源变更统计
- 历史对比

## 📊 功能优先级

### 🔥 第一版（核心功能）
1.  Workspace CRUD + Tags
2.  三种执行模式（Local/Agent/K8s）
3.  生命周期状态机
4.  Plan/Apply任务流程
5.  State版本控制
6.  Workspace锁定
7.  基础Webhook通知
8.  基础日志系统
9.  Plan差异可视化

### 🚀 第二版（扩展功能）
1. ⏳ 插入任务流（审批、扫描）
2. ⏳ 完整通知系统（Prometheus/Loki/S3）
3. ⏳ 完整日志系统（多后端）
4. ⏳ AI Drift检测
5. ⏳ 自动修复建议

### 🌟 第三版（高级功能）
1. ⏳ Workspace Template
2. ⏳ GitOps集成
3. ⏳ 多租户RBAC
4. ⏳ AI风险评估
5. ⏳ 成本预测

## 🔗 文档导航

本文档集包含以下部分：

1. **[00-overview.md](./00-overview.md)** ← 当前文档
   - 总览和架构设计
   
2. **[01-lifecycle.md](./01-lifecycle.md)**
   - 生命周期状态机
   - 状态转换规则
   
3. **[02-execution-modes.md](./02-execution-modes.md)**
   - Local/Agent/K8s执行模式详解
   - 执行器接口设计
   
4. **[03-state-management.md](./03-state-management.md)**
   - State存储和版本控制
   - 锁机制和回滚
   
5. **[04-task-workflow.md](./04-task-workflow.md)**
   - Plan/Apply任务流程
   - 插入任务设计（未来扩展）
   
6. **[05-drift-detection.md](./05-drift-detection.md)**
   - AI漂移检测（后续迭代）
   - 智能分析和报告
   
7. **[06-notification-system.md](./06-notification-system.md)**
   - 通知系统架构
   - 事件和目标配置
   
8. **[07-logging-system.md](./07-logging-system.md)**
   - 日志系统设计
   - 多后端输出
   
9. **[08-database-design.md](./08-database-design.md)**
   - 数据库表结构
   - 索引和约束
   
10. **[09-api-specification.md](./09-api-specification.md)**
    - REST API接口规范
    - 请求/响应格式
    
11. **[10-implementation-guide.md](./10-implementation-guide.md)**
    - 实现指导和最佳实践
    - 开发顺序建议

12. **[11-frontend-design.md](./11-frontend-design.md)**
    - 前端页面设计
    - 6个标签页详细设计
    - 交互规范和用户体验

13. **[12-global-configuration.md](./12-global-configuration.md)**
    - 全局配置管理
    - Agent Pool配置
    - K8s配置
    - Terraform版本配置

14. **[development-progress.md](./development-progress.md)**
    - 开发进度跟踪
    - 按标签页组织的开发任务
    - Sprint优先级

## 🎯 快速开始

### 开发者入口

1. **新手开发者**: 从 [10-implementation-guide.md](./10-implementation-guide.md) 开始
2. **后端开发**: 重点阅读 02、03、04、08、09
3. **前端开发**: 重点阅读 01、04、06、07
4. **架构师**: 阅读全部文档

### 关键概念

- **Workspace**: 工作空间，包含Terraform配置和状态
- **Task**: 任务，包括Plan和Apply
- **Executor**: 执行器，负责实际执行Terraform命令
- **State**: Terraform状态文件
- **Drift**: 资源漂移，实际状态与期望状态的差异

## 📝 版本历史

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| v2.0 | 2025-10-09 | 整合历史需求和新产品设计 |
| v1.0 | 2025-01-02 | 初始版本 |

## 🤝 贡献指南

本文档集为多人/多AI协作开发设计，请遵循以下原则：

1. **保持一致性**: 术语、格式、代码风格统一
2. **详细注释**: 关键逻辑必须有注释说明
3. **示例代码**: 提供可运行的代码示例
4. **更新文档**: 代码变更后及时更新文档

## 📞 联系方式

如有疑问，请通过以下方式联系：

- 项目Issue: [GitHub Issues]
- 技术讨论: [Slack Channel]
- 邮件: dev@iac-platform.com

---

**下一步**: 阅读 [01-lifecycle.md](./01-lifecycle.md) 了解Workspace生命周期设计
