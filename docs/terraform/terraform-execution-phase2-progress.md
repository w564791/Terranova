# Phase 2: Podæ§½ä½ç®¡ç†å®žæ–½è¿›åº¦

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
> **åˆ›å»ºæ—¥æœŸ**: 2025-11-08  
> **çŠ¶æ€**: è¿›è¡Œä¸­  
> **å‰ç½®æ¡ä»¶**: Phase 1å·²å®Œæˆ 

## ðŸ“Š æ€»ä½“è¿›åº¦

**å½“å‰è¿›åº¦**: Step 2.1-2.4 å®Œæˆ (4/8æ­¥éª¤, 60%)  
**é¢„è®¡æ€»å·¥ä½œé‡**: 10å¤©  
**å·²å®Œæˆå·¥ä½œé‡**: 6å¤©  
**å‰©ä½™å·¥ä½œé‡**: 4å¤©

---

##  å·²å®Œæˆå·¥ä½œ

### Step 2.1: åˆ›å»ºPodç®¡ç†å™¨æ ¸å¿ƒæ¡†æž¶ 

**å®Œæˆæ—¶é—´**: 2025-11-08 14:19  
**å·¥ä½œé‡**: 3å¤©  
**æ–‡ä»¶**: `backend/services/k8s_pod_manager.go` (æ–°å»º)

**å®žçŽ°å†…å®¹**:

1.  **æ•°æ®ç»“æž„å®šä¹‰**
   - `PodSlot` - æ§½ä½ç»“æž„ï¼ˆ3ä¸ªæ§½ä½/Podï¼‰
   - `ManagedPod` - Podç®¡ç†ç»“æž„
   - `K8sPodManager` - Podç®¡ç†å™¨

2.  **Podç”Ÿå‘½å‘¨æœŸç®¡ç†**
   - `CreatePod()` - åˆ›å»ºæ–°Pod
   - `DeletePod()` - åˆ é™¤Podï¼ˆæ£€æŸ¥æ§½ä½çŠ¶æ€ï¼‰
   - `ListPods()` - åˆ—å‡ºPoolçš„æ‰€æœ‰Pod
   - `FindIdlePods()` - æŸ¥æ‰¾å®Œå…¨ç©ºé—²çš„Pod

3.  **æ§½ä½ç®¡ç†**
   - `FindPodWithFreeSlot()` - æŸ¥æ‰¾ç©ºé—²æ§½ä½
   - `AssignTaskToSlot()` - åˆ†é…ä»»åŠ¡åˆ°æ§½ä½
   - `ReleaseSlot()` - é‡Šæ”¾æ§½ä½
   - `ReserveSlot()` - é¢„ç•™æ§½ä½ï¼ˆapply_pendingï¼‰

4.  **æ§½ä½ç»Ÿè®¡**
   - `GetSlotStats()` - èŽ·å–æ§½ä½ç»Ÿè®¡
   - `GetPodSlotStatus()` - èŽ·å–Podæ§½ä½çŠ¶æ€

5.  **PodåŒæ­¥å’Œåè°ƒ**
   - `SyncPodsFromK8s()` - ä»ŽK8såŒæ­¥PodçŠ¶æ€
   - `ReconcilePods()` - åè°ƒPodçŠ¶æ€
   - `syncTaskStatusToSlots()` - åŒæ­¥ä»»åŠ¡çŠ¶æ€åˆ°æ§½ä½
   - `cleanupExpiredReservations()` - æ¸…ç†è¿‡æœŸé¢„ç•™

6.  **Agentæ³¨å†Œå’Œå¿ƒè·³**
   - `RegisterAgent()` - æ³¨å†ŒAgentåˆ°Pod
   - `UpdateHeartbeat()` - æ›´æ–°å¿ƒè·³

7.  **è¾…åŠ©æ–¹æ³•**
   - `GetPodCount()` - èŽ·å–Podæ•°é‡
   - `FindPodByAgentID()` - æ ¹æ®AgentIDæŸ¥æ‰¾Pod
   - `FindPodByTaskID()` - æ ¹æ®TaskIDæŸ¥æ‰¾Podå’Œæ§½ä½
   - `buildPodSpec()` - æž„å»ºPodè§„æ ¼

**å…³é”®ç‰¹æ€§**:
- æ¯ä¸ªPodå›ºå®š3ä¸ªæ§½ä½
- Slot 0å¯æ‰§è¡Œä»»ä½•ä»»åŠ¡ï¼ŒSlot 1/2åªèƒ½æ‰§è¡Œplanä»»åŠ¡
- æ§½ä½çŠ¶æ€ï¼šidle, running, reserved
- çº¿ç¨‹å®‰å…¨çš„æ§½ä½ç®¡ç†
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸé¢„ç•™ï¼ˆ24å°æ—¶ï¼‰

---

## â³ å¾…å®Œæˆå·¥ä½œ

### Step 2.2-2.4: K8sDeploymentServiceé‡æž„å’ŒAuto-scaleræ›´æ–° 

**å®Œæˆæ—¶é—´**: 2025-11-08 14:36  
**å·¥ä½œé‡**: 3å¤©  
**æ–‡ä»¶**: `backend/services/k8s_deployment_service.go`

**å®žçŽ°å†…å®¹**:

1.  **æ·»åŠ PodManageré›†æˆ**
   - æ·»åŠ `podManager *K8sPodManager`å­—æ®µ
   - åœ¨æž„é€ å‡½æ•°ä¸­åˆå§‹åŒ–PodManager

2.  **æ ¸å¿ƒæ–¹æ³•é‡æž„**
   - `EnsurePodsForPool()` - æ›¿ä»£EnsureDeploymentForPool
   - `ScalePods()` - æ›¿ä»£ScaleDeploymentï¼Œåªåˆ é™¤ç©ºé—²Pod
   - `GetPodCount()` - æ›¿ä»£GetDeploymentReplicas
   - `AutoScalePods()` - åŸºäºŽæ§½ä½åˆ©ç”¨çŽ‡çš„æ™ºèƒ½æ‰©ç¼©å®¹

3.  **Auto-scaleræ›´æ–°**
   - `runAutoScalerCycle()` - é›†æˆPodåè°ƒå’Œæ§½ä½ç®¡ç†
   - åŸºäºŽæ§½ä½ç»Ÿè®¡çš„æ‰©ç¼©å®¹å†³ç­–
   - ä¿æŠ¤reservedæ§½ä½ï¼ˆapply_pendingä»»åŠ¡ï¼‰

4.  **å‘åŽå…¼å®¹å±‚**
   - ä¿ç•™æ‰€æœ‰æ—§æ–¹æ³•ä½œä¸ºdeprecated
   - è‡ªåŠ¨é‡å®šå‘åˆ°æ–°å®žçŽ°
   - ç¡®ä¿çŽ°æœ‰ä»£ç ä¸ä¸­æ–­

**å…³é”®ç‰¹æ€§**:
- å®‰å…¨ç¼©å®¹ï¼šåªåˆ é™¤æ‰€æœ‰æ§½ä½éƒ½idleçš„Pod
- Applyä¿æŠ¤ï¼šreservedæ§½ä½çš„Podä¸ä¼šè¢«åˆ é™¤
- æ™ºèƒ½æ‰©ç¼©å®¹ï¼šåŸºäºŽæ§½ä½åˆ©ç”¨çŽ‡ï¼ˆ>80%æ‰©å®¹ï¼Œ<20%ç¼©å®¹ï¼‰
- å†·å¯åŠ¨æ”¯æŒï¼šæ£€æµ‹pendingä»»åŠ¡è‡ªåŠ¨åˆ›å»ºPod

### Step 2.5: TaskQueueManageræ›´æ–° (1å¤©)

**ç›®æ ‡**: æ›´æ–°ä»»åŠ¡åˆ†é…é€»è¾‘ï¼Œä½¿ç”¨æ§½ä½ç®¡ç†

**å¾…å®žçŽ°**:
- [ ] ä¿®æ”¹ `pushTaskToAgent()` ä½¿ç”¨æ§½ä½åˆ†é…
- [ ] ä»»åŠ¡å®ŒæˆåŽé‡Šæ”¾æ§½ä½
- [ ] Planå®ŒæˆåŽé¢„ç•™Slot 0

**æ–‡ä»¶**: `backend/services/task_queue_manager.go`

### Step 2.6: Agentç«¯æ§½ä½ç®¡ç† (1å¤©)

**ç›®æ ‡**: Agentç«¯å®žçŽ°æ§½ä½ç®¡ç†

**å¾…å®žçŽ°**:
- [ ] åˆ›å»º `backend/agent/worker/slot_manager.go`
- [ ] å®žçŽ°æ§½ä½èŽ·å–å’Œé‡Šæ”¾
- [ ] ä¸ŠæŠ¥æ§½ä½çŠ¶æ€åˆ°å¹³å°

**æ–‡ä»¶**: `backend/agent/worker/slot_manager.go` (æ–°å»º)

### Step 2.7: main.goæ›´æ–° (0.5å¤©)

**ç›®æ ‡**: é›†æˆæ–°çš„Podç®¡ç†æœåŠ¡

**å¾…å®žçŽ°**:
- [ ] æ›¿æ¢ `K8sDeploymentService` ä¸º `K8sPodService`
- [ ] åˆå§‹åŒ–PodManager
- [ ] å¯åŠ¨Podåè°ƒå™¨

**æ–‡ä»¶**: `backend/main.go`

### Step 2.8: æµ‹è¯•éªŒè¯ (1.5å¤©)

**ç›®æ ‡**: å…¨é¢æµ‹è¯•Podæ§½ä½ç®¡ç†åŠŸèƒ½

**æµ‹è¯•åœºæ™¯**:
- [ ] åŸºæœ¬åŠŸèƒ½æµ‹è¯•ï¼ˆåˆ›å»ºPodã€åˆ†é…æ§½ä½ï¼‰
- [ ] å¹¶å‘æµ‹è¯•ï¼ˆ3ä¸ªplanä»»åŠ¡åˆ°åŒä¸€Podï¼‰
- [ ] ç¼©å®¹æµ‹è¯•ï¼ˆåªåˆ é™¤ç©ºé—²Podï¼‰ å…³é”®
- [ ] Apply_pendingä¿æŠ¤æµ‹è¯•ï¼ˆreservedæ§½ä½ä¸è¢«åˆ é™¤ï¼‰ å…³é”®
- [ ] Agentç¦»çº¿æ¢å¤æµ‹è¯•
- [ ] æ§½ä½è¿‡æœŸæ¸…ç†æµ‹è¯•

---

## ðŸŽ¯ Phase 2 æ ¸å¿ƒä»·å€¼

### è§£å†³çš„é—®é¢˜

**å½“å‰Deploymentæ¨¡å¼çš„é—®é¢˜**:
```
3ä¸ªPodï¼Œæ¯ä¸ªæ‰§è¡Œ1ä¸ªä»»åŠ¡
ç¼©å®¹åˆ°2ä¸ª â†’ K8séšæœºåˆ é™¤1ä¸ªPod
å¯èƒ½åˆ é™¤æ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„Pod âŒ
```

**Podæ§½ä½ç®¡ç†çš„è§£å†³æ–¹æ¡ˆ**:
```
3ä¸ªPodï¼Œæ¯ä¸ªæœ‰3ä¸ªæ§½ä½
ç¼©å®¹æ—¶æ£€æŸ¥æ§½ä½çŠ¶æ€
åªåˆ é™¤æ‰€æœ‰æ§½ä½éƒ½idleçš„Pod 
æœ‰ä»»åŠ¡æˆ–reservedçš„Podä¸ä¼šè¢«åˆ é™¤ 
```

### å…³é”®ä¼˜åŠ¿

1. **ç²¾ç¡®æŽ§åˆ¶** - çŸ¥é“æ¯ä¸ªPodçš„æ§½ä½ä½¿ç”¨æƒ…å†µ
2. **å®‰å…¨ç¼©å®¹** - åªåˆ é™¤å®Œå…¨ç©ºé—²çš„Pod
3. **Applyä¿æŠ¤** - reservedæ§½ä½çš„Podä¸ä¼šè¢«åˆ é™¤
4. **èµ„æºä¼˜åŒ–** - æ›´é«˜çš„Podåˆ©ç”¨çŽ‡ï¼ˆ3ä¸ªæ§½ä½/Podï¼‰

---

## ðŸ“ å®žæ–½å»ºè®®

### å½“å‰çŠ¶æ€

 **Step 2.1å·²å®Œæˆ** - Podç®¡ç†å™¨æ ¸å¿ƒæ¡†æž¶å·²åˆ›å»ºï¼ŒåŒ…å«ï¼š
- å®Œæ•´çš„æ•°æ®ç»“æž„
- Podç”Ÿå‘½å‘¨æœŸç®¡ç†
- æ§½ä½ç®¡ç†åŠŸèƒ½
- åŒæ­¥å’Œåè°ƒæœºåˆ¶

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

ç”±äºŽPhase 2æ˜¯å¤§åž‹é‡æž„ï¼ˆå‰©ä½™9å¤©å·¥ä½œé‡ï¼‰ï¼Œå»ºè®®ï¼š

1. **å…ˆæµ‹è¯•Step 2.1çš„ä»£ç **
   - ç¼–è¯‘æ£€æŸ¥
   - å•å…ƒæµ‹è¯•æ§½ä½åˆ†é…é€»è¾‘
   - éªŒè¯æ•°æ®ç»“æž„è®¾è®¡

2. **ç»§ç»­å®žæ–½Step 2.2-2.8**
   - æŒ‰ç…§å®žæ–½æŒ‡å—é€æ­¥å®Œæˆ
   - æ¯ä¸ªStepå®ŒæˆåŽè¿›è¡Œæµ‹è¯•
   - ä¿æŒDeploymentä½œä¸ºfallback

3. **é£Žé™©æŽ§åˆ¶**
   - ä¿ç•™åŽŸæœ‰Deploymentä»£ç 
   - å¯ä»¥éšæ—¶å›žæ»š
   - Phase 1ä¼˜åŒ–ä¸å—å½±å“

---

## ðŸ”„ å›žæ»šè®¡åˆ’

å¦‚æžœPhase 2å®žæ–½é‡åˆ°é—®é¢˜ï¼š

1. **ä¿ç•™åŽŸæ–‡ä»¶**
   ```bash
   cp backend/services/k8s_deployment_service.go \
      backend/services/k8s_deployment_service.go.backup
   ```

2. **å›žæ»šæ­¥éª¤**
   - æ¢å¤åŽŸæœ‰çš„Deploymentä»£ç 
   - ç§»é™¤PodManagerç›¸å…³ä»£ç 
   - Phase 1ä¼˜åŒ–ç»§ç»­æœ‰æ•ˆ

3. **å½±å“èŒƒå›´**
   - åªå½±å“K8sæ¨¡å¼çš„agent pool
   - Localå’ŒAgentæ¨¡å¼ä¸å—å½±å“
   - Phase 1ä¼˜åŒ–ï¼ˆä¿æŒå·¥ä½œç›®å½•ï¼‰ç»§ç»­æœ‰æ•ˆ

---

## ðŸ“Š å·¥ä½œé‡åˆ†è§£

| Step | å†…å®¹ | çŠ¶æ€ | å·¥ä½œé‡ | å‰©ä½™ |
|------|------|------|--------|------|
| 2.1 | Podç®¡ç†å™¨æ ¸å¿ƒ |  å®Œæˆ | 2å¤© | 0å¤© |
| 2.2-2.4 | K8sDeploymentServiceé‡æž„ |  å®Œæˆ | 4å¤© | 0å¤© |
| 2.5 | TaskQueueManager | â³ å¾…å®žæ–½ | 1å¤© | 1å¤© |
| 2.6 | Agentç«¯æ§½ä½ç®¡ç† | â³ å¾…å®žæ–½ | 1å¤© | 1å¤© |
| 2.7 | main.goæ›´æ–° | â³ å¾…å®žæ–½ | 0.5å¤© | 0.5å¤© |
| 2.8 | æµ‹è¯•éªŒè¯ | â³ å¾…å®žæ–½ | 1.5å¤© | 1.5å¤© |
| **æ€»è®¡** | | | **10å¤©** | **4å¤©** |

---

## ðŸ“– ç›¸å…³æ–‡æ¡£

- [terraform-execution-phase2-pod-slot-implementation.md](terraform-execution-phase2-pod-slot-implementation.md) - Phase 2å®žæ–½æŒ‡å—
- [terraform-execution-optimization-analysis.md](terraform-execution-optimization-analysis.md) - ä¼˜åŒ–æ–¹æ¡ˆåˆ†æž
- [terraform-execution-optimization-progress.md](terraform-execution-optimization-progress.md) - Phase 1è¿›åº¦

---

**ä¸‹ä¸€æ­¥**: ç»§ç»­å®žæ–½Step 2.5 - TaskQueueManageræ›´æ–°ï¼ˆæ§½ä½åˆ†é…é›†æˆï¼‰

**è¯¦ç»†æŠ¥å‘Š**: å‚è§ [terraform-execution-phase2-step-2.3-2.4-complete.md](terraform-execution-phase2-step-2.3-2.4-complete.md)
