# MFA（多因素认证）功能设计文档

> **状态**: ✅ 已实现
> **完成日期**: 2026-02-09

## 1. 概述

### 1.1 功能目标
为IaC Platform平台实现基于TOTP（Time-based One-Time Password）的多因素认证功能，支持Google Authenticator等标准TOTP应用，增强用户账户安全性。

### 1.2 核心需求
| 需求 | 描述 |
|------|------|
| 新用户MFA | 首次登录时必须设置MFA（扫描二维码或手动输入密钥） |
| 存量用户MFA | 可以选择启用MFA，或根据全局策略被强制要求启用 |
| 全局强制策略 | 管理员可配置是否强制所有用户启用MFA |
| 标准兼容 | 支持Google Authenticator、Microsoft Authenticator、Authy等标准TOTP应用 |
| 备用恢复 | 提供备用恢复码，防止用户丢失设备后无法登录 |

### 1.3 非功能需求
| 需求 | 描述 |
|------|------|
| 安全性 | MFA密钥加密存储，防暴力破解 |
| 可用性 | 设置流程简单，提供清晰的操作指引 |
| 可审计 | 所有MFA相关操作记录审计日志 |
| 可管理 | 管理员可查看MFA使用统计，可重置用户MFA |

---

## 2. 技术方案

### 2.1 TOTP算法规格
| 参数 | 值 | 说明 |
|------|-----|------|
| 算法 | HMAC-SHA1 | RFC 6238标准 |
| 时间步长 | 30秒 | 验证码每30秒更新 |
| 验证码长度 | 6位数字 | 标准长度 |
| 密钥长度 | 160位 | Base32编码后为32字符 |
| 时间容差 | ±1步 | 允许前后各30秒的验证码 |

### 2.2 依赖库选型
| 语言 | 库 | 用途 |
|------|-----|------|
| Go | pquerna/otp | TOTP生成和验证 |
| Go | skip2/go-qrcode | 二维码生成 |
| React | qrcode.react | 二维码显示组件 |

---

## 3. 数据库设计

### 3.1 用户表扩展字段
| 字段名 | 类型 | 说明 |
|--------|------|------|
| mfa_enabled | BOOLEAN | MFA是否已启用，默认false |
| mfa_secret | VARCHAR(64) | TOTP密钥（AES加密存储） |
| mfa_verified_at | TIMESTAMP | MFA首次验证成功时间 |
| mfa_backup_codes | TEXT | 备用恢复码（JSON数组，AES加密存储） |
| mfa_failed_attempts | INTEGER | MFA验证失败次数，用于防暴力破解 |
| mfa_locked_until | TIMESTAMP | MFA锁定截止时间 |

### 3.2 系统配置项
| 配置键 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| mfa_enabled | boolean | true | 是否启用MFA功能 |
| mfa_enforcement | string | "optional" | MFA强制策略 |
| mfa_enforcement_enabled_at | timestamp | null | 强制策略启用时间（用于判断新用户和宽限期） |
| mfa_issuer | string | "IaC Platform" | TOTP发行者名称 |
| mfa_grace_period_days | integer | 7 | 强制MFA的宽限期（天） |
| mfa_max_failed_attempts | integer | 5 | 最大失败尝试次数 |
| mfa_lockout_duration_minutes | integer | 15 | 锁定时长（分钟） |

### 3.3 MFA强制策略说明
| 策略值 | 说明 | 适用场景 |
|--------|------|----------|
| optional | 用户可自行选择是否启用MFA | 内部系统、低安全要求 |
| required_new | 新用户必须设置MFA，存量用户可选 | 渐进式推广MFA |
| required_all | 所有用户必须启用MFA | 高安全要求环境 |

**新用户判断逻辑**：
- `required_new`策略下，"新用户"定义为：策略启用后创建的用户
- 通过比较用户`created_at`与策略启用时间来判断
- 需要在系统配置中记录`mfa_enforcement_enabled_at`时间戳

**宽限期计算基准**：
- `required_all`策略下，宽限期从策略启用时间开始计算
- 宽限期 = 当前时间 - `mfa_enforcement_enabled_at`
- 超过`mfa_grace_period_days`天后，未设置MFA的用户将被强制设置

### 3.4 MFA审计日志类型
| action | 描述 | 记录内容 |
|--------|------|----------|
| mfa_setup_initiated | 用户开始设置MFA | 用户ID、时间 |
| mfa_setup_completed | 用户完成MFA设置 | 用户ID、时间 |
| mfa_disabled | 用户禁用MFA | 用户ID、时间、操作者 |
| mfa_verify_success | MFA验证成功 | 用户ID、时间、IP |
| mfa_verify_failed | MFA验证失败 | 用户ID、时间、IP、失败原因 |
| mfa_backup_code_used | 使用备用恢复码 | 用户ID、时间、剩余恢复码数量 |
| mfa_backup_codes_regenerated | 重新生成备用恢复码 | 用户ID、时间 |
| mfa_reset_by_admin | 管理员重置用户MFA | 用户ID、管理员ID、时间 |
| mfa_locked | 账户因多次失败被锁定 | 用户ID、时间、锁定时长 |

---

## 4. API设计

### 4.1 用户MFA设置API

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 获取MFA状态 | GET | /api/v1/user/mfa/status | 查询当前用户MFA设置状态 |
| 初始化MFA设置 | POST | /api/v1/user/mfa/setup | 生成密钥和二维码 |
| 验证并启用MFA | POST | /api/v1/user/mfa/verify | 验证TOTP码并启用MFA |
| 禁用MFA | POST | /api/v1/user/mfa/disable | 禁用MFA（需验证密码和TOTP） |
| 重新生成恢复码 | POST | /api/v1/user/mfa/backup-codes/regenerate | 重新生成备用恢复码 |

### 4.2 登录流程API

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 登录（第一步） | POST | /api/v1/auth/login | 验证用户名密码，返回是否需要MFA |
| MFA验证（第二步） | POST | /api/v1/auth/mfa/verify | 验证TOTP码或恢复码，返回JWT |

### 4.3 管理员API

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 获取MFA全局配置 | GET | /api/v1/admin/settings/mfa | 获取MFA全局配置和统计 |
| 更新MFA全局配置 | PUT | /api/v1/admin/settings/mfa | 更新MFA全局配置 |
| 重置用户MFA | POST | /api/v1/admin/users/{user_id}/mfa/reset | 重置指定用户的MFA |
| 查看用户MFA状态 | GET | /api/v1/admin/users/{user_id}/mfa/status | 查看指定用户MFA状态 |

### 4.4 API响应设计要点

#### 登录响应（需要MFA验证时）
- 返回临时令牌（mfa_token），有效期5分钟
- 返回用户部分信息（用户名，不含敏感信息）
- 不返回JWT，直到MFA验证通过

#### MFA设置响应
- 密钥仅在初始化时返回一次
- 二维码以Base64格式返回
- 同时返回otpauth URI供手动输入
- 备用恢复码仅在生成时返回一次

---

## 5. 前端设计

### 5.1 页面规划

#### 新增页面
| 页面 | 路径 | 描述 | 访问权限 |
|------|------|------|----------|
| MFA设置页面 | /settings/mfa | 用户MFA设置和管理 | 已登录用户 |
| MFA验证页面 | /login/mfa | 登录时的MFA验证 | 登录中用户 |
| MFA强制设置页面 | /setup/mfa | 新用户首次登录时的MFA设置 | 新用户 |
| 安全设置页面 | /admin/settings/security | 管理员MFA全局配置 | 管理员 |

#### 修改页面
| 页面 | 修改内容 |
|------|----------|
| 登录页面 | 增加MFA验证步骤，支持两步登录流程 |
| 个人设置页面 | 增加MFA设置入口和状态显示 |
| 用户管理页面 | 增加MFA状态列、重置MFA操作 |

### 5.2 用户MFA设置流程

**步骤1：扫描二维码**
- 显示二维码图片
- 提供操作指引（打开Authenticator → 添加账户 → 扫描）
- 提供"无法扫描"选项，显示Base32密钥供手动输入
- 密钥旁提供复制按钮

**步骤2：输入验证码**
- 6位数字输入框，支持自动聚焦和跳转
- 验证按钮
- 显示验证错误信息

**步骤3：保存备用恢复码**
- 显示10个恢复码
- 警告提示：每个码只能使用一次
- 提供下载和复制功能
- 确认已保存后完成设置

### 5.3 登录MFA验证流程

**主要界面**
- 标题：两步验证
- 提示：请输入Authenticator应用中显示的验证码
- 6位数字输入框
- 验证按钮
- 错误提示区域

**备用选项**
- "无法访问Authenticator？"链接
- 点击后切换到恢复码输入界面
- 8位恢复码输入框

### 5.4 管理员全局设置页面

**MFA功能开关**
- 启用/禁用MFA功能的开关
- 说明文字

**MFA强制策略**
- 单选框组：可选、新用户必须、所有用户必须
- 每个选项的说明文字

**宽限期设置**
- 仅在"所有用户必须"模式下显示
- 数字输入框，单位：天
- 说明：存量用户在此期间可正常登录但会收到提醒

**发行者名称**
- 文本输入框
- 说明：显示在Authenticator应用中的账户名称

**MFA使用统计**
- 总用户数
- 已启用MFA用户数和百分比
- 进度条可视化

---

## 6. 用户流程设计

### 6.1 新用户首次登录流程
1. 用户输入用户名密码
2. 密码验证成功
3. 系统检测到用户未设置MFA且策略要求设置
4. 跳转到MFA设置页面
5. 用户扫描二维码
6. 用户输入验证码验证
7. 用户保存备用恢复码
8. 设置完成，进入系统

### 6.2 存量用户登录流程（MFA已启用）
1. 用户输入用户名密码
2. 密码验证成功
3. 系统返回需要MFA验证
4. 跳转到MFA验证页面
5. 用户输入验证码
6. 验证成功，进入系统

### 6.3 存量用户登录流程（MFA未启用，强制模式）
1. 用户输入用户名密码
2. 密码验证成功
3. 系统检测到用户未设置MFA
4. 检查是否在宽限期内
   - 宽限期内：显示提醒，允许跳过，进入系统
   - 宽限期外：强制跳转到MFA设置页面
5. 完成MFA设置后进入系统

### 6.4 用户丢失设备恢复流程
1. 用户在MFA验证页面选择"使用备用恢复码"
2. 输入8位恢复码
3. 验证成功，进入系统
4. 系统提示剩余恢复码数量
5. 建议用户重新设置MFA或生成新的恢复码

### 6.5 管理员重置用户MFA流程
1. 管理员在用户管理页面找到目标用户
2. 点击"重置MFA"按钮
3. 确认操作（二次确认）
4. 系统清除用户MFA设置
5. 记录审计日志
6. 用户下次登录需要重新设置MFA

---

## 7. 安全设计

### 7.1 密钥存储安全
| 措施 | 说明 |
|------|------|
| 加密算法 | AES-256-GCM |
| 加密密钥 | 复用统一加密服务，基于JWT_SECRET通过SHA256生成 |
| 加密服务 | 复用`backend/internal/crypto/variable_crypto.go` |
| 加密范围 | MFA密钥、备用恢复码 |
| 向后兼容 | 支持明文数据自动识别（迁移期间） |

**说明**：MFA密钥加密复用现有的统一加密服务，不单独设置加密密钥。这样可以：
- 统一管理所有敏感数据的加密
- 简化密钥管理，避免多套密钥
- 复用现有的加密/解密函数

### 7.2 防暴力破解
| 措施 | 说明 |
|------|------|
| 失败次数限制 | 5次/5分钟 |
| 锁定机制 | 超过限制后锁定账户15分钟 |
| 锁定通知 | 发送邮件通知用户账户被锁定 |
| 审计日志 | 记录所有失败尝试 |

### 7.3 临时令牌安全
| 措施 | 说明 |
|------|------|
| 有效期 | 5分钟 |
| IP绑定 | 临时令牌绑定请求IP |
| 一次性 | 验证成功后立即失效 |
| 存储 | 存储在数据库（项目当前未使用Redis） |

### 7.4 备用恢复码安全
| 措施 | 说明 |
|------|------|
| 数量 | 10个 |
| 格式 | 8位数字 |
| 使用限制 | 每个码只能使用一次 |
| 存储 | 加密存储，使用后标记为已使用 |
| 重新生成 | 需要当前TOTP验证 |

### 7.5 会话安全
| 措施 | 说明 |
|------|------|
| MFA验证后 | 生成新的会话ID |
| 敏感操作 | 禁用MFA需要重新验证密码 |
| 会话标记 | JWT中标记是否通过MFA验证 |

---

## 8. 错误处理

### 8.1 错误码定义
| 错误码 | HTTP状态码 | 说明 |
|--------|------------|------|
| MFA_NOT_ENABLED | 400 | MFA功能未启用 |
| MFA_ALREADY_ENABLED | 400 | 用户已启用MFA |
| MFA_NOT_SETUP | 400 | 用户未设置MFA |
| MFA_INVALID_CODE | 401 | MFA验证码无效 |
| MFA_CODE_EXPIRED | 401 | MFA验证码已过期 |
| MFA_TOKEN_INVALID | 401 | MFA临时令牌无效 |
| MFA_TOKEN_EXPIRED | 401 | MFA临时令牌已过期 |
| MFA_RATE_LIMITED | 429 | MFA验证次数超限 |
| MFA_ACCOUNT_LOCKED | 423 | 账户已锁定 |
| MFA_BACKUP_CODE_INVALID | 401 | 备用恢复码无效 |
| MFA_BACKUP_CODE_USED | 401 | 备用恢复码已使用 |
| MFA_CANNOT_DISABLE | 403 | 无法禁用MFA（强制模式） |
| MFA_SETUP_REQUIRED | 403 | 需要先设置MFA |

### 8.2 用户友好提示
| 场景 | 提示信息 |
|------|----------|
| 验证码错误 | 验证码不正确，请检查后重试 |
| 验证码过期 | 验证码已过期，请输入最新的验证码 |
| 账户锁定 | 由于多次验证失败，账户已被锁定15分钟 |
| 恢复码用尽 | 所有恢复码已使用，请联系管理员 |
| 强制MFA | 根据安全策略，您需要先设置MFA才能继续使用系统 |

---

## 9. 实现计划

### 9.1 第一阶段：基础MFA功能（预计3天）
- [ ] 数据库迁移脚本
- [ ] 后端MFA服务实现（密钥生成、验证、加密存储）
- [ ] MFA设置API（初始化、验证、禁用）
- [ ] 登录流程MFA验证集成
- [ ] 备用恢复码功能

### 9.2 第二阶段：前端页面（预计2天）
- [ ] MFA设置页面（二维码、密钥、恢复码）
- [ ] MFA验证页面（验证码输入、恢复码输入）
- [ ] 登录页面集成（两步登录流程）
- [ ] 个人设置页面集成（MFA状态、设置入口）

### 9.3 第三阶段：管理功能（预计1天）
- [ ] 全局MFA配置页面
- [ ] 用户MFA状态管理
- [ ] MFA重置功能
- [ ] MFA使用统计

### 9.4 第四阶段：测试和文档（预计1天）
- [ ] 单元测试
- [ ] 集成测试
- [ ] 用户操作文档
- [ ] 管理员操作文档

---

## 10. 与现有系统集成

### 10.1 认证系统集成
| 集成点 | 说明 |
|--------|------|
| 登录流程 | 在密码验证后增加MFA验证步骤 |
| JWT令牌 | 增加mfa_verified字段标记是否通过MFA |
| 会话管理 | MFA验证后刷新会话 |

### 10.2 用户管理集成
| 集成点 | 说明 |
|--------|------|
| 用户列表 | 显示MFA状态列 |
| 用户详情 | 显示MFA设置时间、最后验证时间 |
| 用户操作 | 增加重置MFA操作 |

### 10.3 审计系统集成
| 集成点 | 说明 |
|--------|------|
| 审计日志 | 复用现有audit_logs表 |
| 日志类型 | 增加MFA相关操作类型 |
| 日志查询 | 支持按MFA操作类型筛选 |

### 10.4 通知系统集成
| 集成点 | 说明 |
|--------|------|
| 账户锁定 | 发送邮件通知 |
| MFA设置 | 发送设置成功通知 |
| 恢复码使用 | 发送使用提醒 |

---

## 11. 待确认事项

### 11.1 技术决策
1. ~~**密钥加密方式**~~：✅ 已确认，复用现有统一加密服务（`backend/internal/crypto/variable_crypto.go`）
2. **临时令牌存储**：使用Redis还是数据库存储MFA临时令牌？（建议：数据库，项目当前未使用Redis）
3. **二维码生成**：后端生成还是前端生成？（建议：后端生成，便于统一管理otpauth URI）

### 11.2 业务决策
1. **备用恢复码数量**：默认10个是否合适？
2. **宽限期默认值**：7天是否合适？
3. **锁定时长**：15分钟是否合适？
4. **是否需要支持短信/邮件验证码**：作为TOTP的备选方案？

### 11.3 权限决策
1. **管理员重置MFA**：需要什么级别的权限？是否需要二次确认？
2. **用户禁用MFA**：在强制模式下是否允许用户禁用？
3. **查看MFA状态**：普通用户是否可以查看其他用户的MFA状态？

---

## 12. 参考资料

- RFC 6238 - TOTP: Time-Based One-Time Password Algorithm
- Google Authenticator Key URI Format
- OWASP MFA Cheat Sheet